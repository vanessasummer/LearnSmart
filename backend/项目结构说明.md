# å„¿ç«¥å­¦ä¹ è®°å½•AIç³»ç»Ÿ - åç«¯é¡¹ç›®ç»“æ„è¯´æ˜

## ğŸ“‹ é¡¹ç›®æ¦‚è§ˆ

**é¡¹ç›®åç§°**: child-learning-ai-backend  
**æŠ€æœ¯æ ˆ**: Python 3.11 + FastAPI + SQLite + SQLAlchemy  
**å¼€å‘æ¨¡å¼**: å¼‚æ­¥I/O (asyncio)  
**å‰ç«¯æŠ€æœ¯**: Flutter 3 (å•ç‹¬é¡¹ç›®)

---

## ğŸ“‚ å®Œæ•´ç›®å½•ç»“æ„

```
child-learning-ai-backend/
â”œâ”€â”€ app/                           # ä¸»åº”ç”¨ç›®å½•
â”‚   â”œâ”€â”€ __init__.py               # åº”ç”¨åŒ…åˆå§‹åŒ–
â”‚   â”œâ”€â”€ main.py                   # FastAPIåº”ç”¨å…¥å£ â­
â”‚   â”œâ”€â”€ config.py                 # é…ç½®ç®¡ç†(è¯»å–.env)
â”‚   â”œâ”€â”€ database.py               # æ•°æ®åº“è¿æ¥ä¸ä¼šè¯ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                      # APIè·¯ç”±å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ chat.py              # å¯¹è¯ç›¸å…³API
â”‚   â”‚   â”œâ”€â”€ memory.py            # Memoryç®¡ç†API
â”‚   â”‚   â”œâ”€â”€ materials.py         # ä½œæ–‡ç´ æAPI
â”‚   â”‚   â”œâ”€â”€ analysis.py          # åˆ†ææŠ¥å‘ŠAPI
â”‚   â”‚   â””â”€â”€ users.py             # ç”¨æˆ·ç®¡ç†API
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                     # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ ai_engine.py         # AIå¯¹è¯å¼•æ“ â­
â”‚   â”‚   â”œâ”€â”€ memory_manager.py    # Memoryç®¡ç†å™¨ â­
â”‚   â”‚   â”œâ”€â”€ extractor.py         # ä¿¡æ¯æå–å¼•æ“
â”‚   â”‚   â”œâ”€â”€ mode_manager.py      # å¯¹è¯æ¨¡å¼ç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ recommender.py       # ä½œæ–‡ç´ ææ¨è
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                   # æ•°æ®æ¨¡å‹(SQLAlchemy ORM)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py              # ç”¨æˆ·æ¨¡å‹(Child, Parent)
â”‚   â”‚   â”œâ”€â”€ conversation.py      # å¯¹è¯æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ knowledge.py         # çŸ¥è¯†ç‚¹æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ material.py          # ä½œæ–‡ç´ ææ¨¡å‹
â”‚   â”‚   â””â”€â”€ memory.py            # Memoryæ¨¡å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ schemas/                  # Pydanticæ•°æ®éªŒè¯
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ chat.py              # å¯¹è¯è¯·æ±‚/å“åº”Schema
â”‚   â”‚   â””â”€â”€ response.py          # é€šç”¨å“åº”Schema
â”‚   â”‚
â”‚   â””â”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ prompt_manager.py    # Promptæ¨¡æ¿ç®¡ç† â­
â”‚       â””â”€â”€ api_client.py        # è±†åŒ…APIå®¢æˆ·ç«¯ â­
â”‚
â”œâ”€â”€ data/                         # æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ .gitkeep                 # å ä½æ–‡ä»¶
â”‚   â””â”€â”€ learning_ai.db           # SQLiteæ•°æ®åº“(è¿è¡ŒSQLè„šæœ¬åç”Ÿæˆ)
â”‚
â”œâ”€â”€ logs/                         # æ—¥å¿—ç›®å½•
â”‚   â””â”€â”€ .gitkeep                 # å ä½æ–‡ä»¶
â”‚
â”œâ”€â”€ tests/                        # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ test_ai_engine.py        # AIå¼•æ“æµ‹è¯•
â”‚   â””â”€â”€ test_memory.py           # Memoryç³»ç»Ÿæµ‹è¯•
â”‚
â”œâ”€â”€ æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬.sql          # æ•°æ®åº“å»ºè¡¨è„šæœ¬ â­
â”œâ”€â”€ requirements.txt              # Pythonä¾èµ–åŒ…åˆ—è¡¨
â”œâ”€â”€ .env                          # ç¯å¢ƒå˜é‡é…ç½®(éœ€å¡«å†™APIå¯†é’¥) â­
â”œâ”€â”€ .gitignore                    # Gitå¿½ç•¥è§„åˆ™
â””â”€â”€ README.md                     # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

**â­ = æ ¸å¿ƒæ–‡ä»¶,éœ€è¦é‡ç‚¹å…³æ³¨**

---

## ğŸ”§ æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 1. **app/main.py** - åº”ç”¨å…¥å£
- åˆ›å»ºFastAPIåº”ç”¨å®ä¾‹
- é…ç½®CORSä¸­é—´ä»¶
- æ³¨å†Œæ‰€æœ‰APIè·¯ç”±
- æä¾›å¥åº·æ£€æŸ¥æ¥å£

**å…³é”®ä»£ç **:
```python
app = FastAPI(title="å„¿ç«¥å­¦ä¹ è®°å½•AI")
app.include_router(chat.router, prefix="/api/chat")
```

---

### 2. **app/config.py** - é…ç½®ç®¡ç†
- ä½¿ç”¨`pydantic-settings`è¯»å–`.env`æ–‡ä»¶
- ç®¡ç†è±†åŒ…APIå¯†é’¥ã€æ•°æ®åº“URLç­‰é…ç½®
- æä¾›å…¨å±€é…ç½®å¯¹è±¡`settings`

**é…ç½®é¡¹**:
- `DOUBAO_API_KEY`: è±†åŒ…APIå¯†é’¥
- `DATABASE_URL`: æ•°æ®åº“è¿æ¥åœ°å€
- `DEBUG`: è°ƒè¯•æ¨¡å¼å¼€å…³

---

### 3. **app/database.py** - æ•°æ®åº“ç®¡ç†
- åˆ›å»ºå¼‚æ­¥æ•°æ®åº“å¼•æ“
- æä¾›å¼‚æ­¥ä¼šè¯å·¥å‚
- å®ç°`get_db()`ä¾èµ–æ³¨å…¥å‡½æ•°

**å…³é”®ä»£ç **:
```python
engine = create_async_engine(settings.DATABASE_URL)
async def get_db() -> AsyncSession:
    async with AsyncSessionLocal() as session:
        yield session
```

---

### 4. **app/api/** - APIè·¯ç”±å±‚
æ‰€æœ‰APIç«¯ç‚¹çš„å®ç°,æ¯ä¸ªæ–‡ä»¶è´Ÿè´£ä¸€ä¸ªåŠŸèƒ½æ¨¡å—:

| æ–‡ä»¶ | åŠŸèƒ½ | ä¸»è¦ç«¯ç‚¹ |
|------|------|----------|
| `chat.py` | å¯¹è¯ç®¡ç† | `POST /api/chat/send` |
| `memory.py` | MemoryæŸ¥è¯¢ | `GET /api/memory/{child_id}` |
| `materials.py` | ä½œæ–‡ç´ æ | `GET /api/materials/recommend` |
| `analysis.py` | æˆé•¿åˆ†æ | `GET /api/analysis/{child_id}` |
| `users.py` | ç”¨æˆ·ç®¡ç† | `POST /api/users/children` |

**æ‰€æœ‰APIéƒ½æ”¯æŒFastAPIè‡ªåŠ¨æ–‡æ¡£**: è®¿é—® `http://localhost:8000/docs`

---

### 5. **app/core/** - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

#### 5.1 `ai_engine.py` - AIå¯¹è¯å¼•æ“ â­â­â­
**èŒè´£**:
- è°ƒç”¨è±†åŒ…APIè¿›è¡Œå¯¹è¯
- åŠ è½½å’Œæ³¨å…¥Memory
- æå–å¯¹è¯ä¸­çš„ç»“æ„åŒ–ä¿¡æ¯
- æ›´æ–°Memory

**å…³é”®æ–¹æ³•**:
```python
async def chat(self, child_id, message, mode):
    # 1. åŠ è½½Memory
    # 2. è°ƒç”¨è±†åŒ…API
    # 3. æå–ä¿¡æ¯
    # 4. æ›´æ–°Memory
    return response
```

#### 5.2 `memory_manager.py` - Memoryç®¡ç†å™¨ â­â­â­
**èŒè´£**:
- ç®¡ç†é•¿æœŸ/çŸ­æœŸ/å·¥ä½œè®°å¿†
- æ ¼å¼åŒ–Memoryç”¨äºPromptæ³¨å…¥
- ä»æå–çš„ä¿¡æ¯æ›´æ–°Memory

#### 5.3 `extractor.py` - ä¿¡æ¯æå–å¼•æ“
**èŒè´£**:
- ä»AIå“åº”ä¸­æå–çŸ¥è¯†ç‚¹
- æå–ä½œæ–‡ç´ æã€æƒ…ç»ªã€æ€§æ ¼ç­‰ä¿¡æ¯
- è¿”å›ç»“æ„åŒ–JSONæ•°æ®

#### 5.4 `mode_manager.py` - å¯¹è¯æ¨¡å¼ç®¡ç†å™¨
**èŒè´£**:
- ç®¡ç†"è‡ªç”±äº¤æµæ¨¡å¼"å’Œ"çŸ¥è¯†è®°å½•æ¨¡å¼"
- åˆ¤æ–­æ¨¡å¼åˆ‡æ¢æ—¶æœº
- ç”Ÿæˆå¯¹åº”æ¨¡å¼çš„PromptæŒ‡ä»¤

#### 5.5 `recommender.py` - ä½œæ–‡ç´ ææ¨è
**èŒè´£**:
- æ ¹æ®ä½œæ–‡é¢˜ç›®åŒ¹é…ç´ æ
- è®¡ç®—ç›¸ä¼¼åº¦å¹¶æ’åº
- è¿”å›Top Kæ¨èç»“æœ

---

### 6. **app/models/** - æ•°æ®æ¨¡å‹(ORM)
ä½¿ç”¨SQLAlchemyå®šä¹‰æ•°æ®åº“è¡¨ç»“æ„:

| æ–‡ä»¶ | æ¨¡å‹ | è¡¨å | è¯´æ˜ |
|------|------|------|------|
| `user.py` | `Child` | `children` | å­©å­ä¿¡æ¯ |
| `conversation.py` | `Conversation` | `conversations` | å¯¹è¯ä¼šè¯ |
| `knowledge.py` | `KnowledgePoint` | `knowledge_points` | çŸ¥è¯†ç‚¹ |
| `material.py` | `WritingMaterial` | `writing_materials` | ä½œæ–‡ç´ æ |
| `memory.py` | `Memory` | `memories` | Memoryæ•°æ® |

---

### 7. **app/schemas/** - æ•°æ®éªŒè¯
ä½¿ç”¨Pydanticå®šä¹‰APIè¯·æ±‚/å“åº”çš„æ•°æ®ç»“æ„:

**ç¤ºä¾‹**:
```python
class ChatRequest(BaseModel):
    child_id: int
    message: str
    mode: str = "knowledge"

class ChatResponse(BaseModel):
    message: str
    conversation_id: int
    extracted_info: Dict
```

---

### 8. **app/utils/** - å·¥å…·æ¨¡å—

#### 8.1 `prompt_manager.py` - Promptç®¡ç†å™¨ â­â­â­
**èŒè´£**:
- åŠ è½½Promptæ¨¡æ¿(ä»äº‘ç›˜çš„Prompt_v2.1.md)
- æ ¹æ®æ¨¡å¼å’ŒMemoryç”Ÿæˆå®Œæ•´Prompt
- å®ç°Memoryæ³¨å…¥é€»è¾‘

**å»ºè®®å®ç°**:
```python
class PromptManager:
    def get_system_prompt(self, mode, memory):
        base = self._load_base_prompt(mode)
        memory_injection = self._format_memory(memory)
        return f"{base}\n\n{memory_injection}"
```

#### 8.2 `api_client.py` - è±†åŒ…APIå®¢æˆ·ç«¯ â­â­â­
**èŒè´£**:
- å°è£…è±†åŒ…APIçš„HTTPè°ƒç”¨
- å¤„ç†è®¤è¯å’Œé”™è¯¯é‡è¯•
- æ”¯æŒæµå¼å“åº”

**ç¤ºä¾‹è°ƒç”¨**:
```python
client = DouBaoClient()
response = await client.chat(
    message="ä»Šå¤©å­¦äº†ä»€ä¹ˆ?",
    system_prompt=prompt_manager.get_system_prompt(...)
)
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

#### 1. `children` - å­©å­ä¿¡æ¯è¡¨
```sql
CREATE TABLE children (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    age INTEGER,
    grade TEXT,
    created_at DATETIME
);
```

#### 2. `conversations` - å¯¹è¯ä¼šè¯è¡¨
```sql
CREATE TABLE conversations (
    id INTEGER PRIMARY KEY,
    child_id INTEGER,
    mode TEXT,  -- 'free' or 'knowledge'
    turn_count INTEGER,
    created_at DATETIME
);
```

#### 3. `knowledge_points` - çŸ¥è¯†ç‚¹è¡¨
```sql
CREATE TABLE knowledge_points (
    id INTEGER PRIMARY KEY,
    child_id INTEGER,
    conversation_id INTEGER,
    type TEXT,     -- Type 1-5
    subject TEXT,  -- å­¦ç§‘
    content TEXT,
    created_at DATETIME
);
```

#### 4. `writing_materials` - ä½œæ–‡ç´ æè¡¨
```sql
CREATE TABLE writing_materials (
    id INTEGER PRIMARY KEY,
    child_id INTEGER,
    material_type TEXT,  -- äººç‰©/äº‹ä»¶/å¿ƒç†/åœºæ™¯/å“²ç†
    content TEXT,
    tags TEXT,  -- JSONæ•°ç»„
    created_at DATETIME
);
```

#### 5. `memories` - Memoryè¡¨
```sql
CREATE TABLE memories (
    id INTEGER PRIMARY KEY,
    child_id INTEGER,
    memory_type TEXT,  -- long_term/short_term/working
    category TEXT,     -- å…´è¶£/æ€§æ ¼/ä¹ æƒ¯
    key TEXT,
    value TEXT,
    updated_at DATETIME
);
```

**å®Œæ•´å»ºè¡¨è„šæœ¬**: è§`æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬.sql`

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### ç¬¬ä¸€æ­¥:ç¯å¢ƒå‡†å¤‡
```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# å®‰è£…ä¾èµ–
cd child-learning-ai-backend
pip install -r requirements.txt
```

### ç¬¬äºŒæ­¥:æ•°æ®åº“åˆå§‹åŒ–
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œ
sqlite3 data/learning_ai.db < æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬.sql

# éªŒè¯è¡¨æ˜¯å¦åˆ›å»º
sqlite3 data/learning_ai.db ".tables"
```

### ç¬¬ä¸‰æ­¥:é…ç½®ç¯å¢ƒå˜é‡
ç¼–è¾‘`.env`æ–‡ä»¶,å¡«å†™æ‚¨çš„è±†åŒ…APIå¯†é’¥:
```bash
DOUBAO_API_KEY=your_actual_api_key_here
DOUBAO_API_SECRET=your_actual_secret_here
DOUBAO_MODEL_ID=your_model_id_here
```

### ç¬¬å››æ­¥:å¯åŠ¨æœåŠ¡
```bash
# å¼€å‘æ¨¡å¼(è‡ªåŠ¨é‡è½½)
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# æˆ–ç›´æ¥è¿è¡Œ
python app/main.py
```

### ç¬¬äº”æ­¥:æµ‹è¯•API
æ‰“å¼€æµè§ˆå™¨è®¿é—®:
- **APIæ–‡æ¡£**: http://localhost:8000/docs
- **å¥åº·æ£€æŸ¥**: http://localhost:8000/health

---

## ğŸ” é‡è¦æé†’

### âš ï¸ éœ€è¦è‡ªå·±å¡«å†™çš„å†…å®¹

1. **`.env`æ–‡ä»¶** - è±†åŒ…APIå¯†é’¥
   ```
   DOUBAO_API_KEY=åœ¨ç«å±±å¼•æ“æ§åˆ¶å°è·å–
   DOUBAO_API_SECRET=åœ¨ç«å±±å¼•æ“æ§åˆ¶å°è·å–
   DOUBAO_MODEL_ID=è±†åŒ…æ¨¡å‹ID
   ```

2. **`app/utils/prompt_manager.py`** - åŠ è½½Promptæ¨¡æ¿
   - ä»äº‘ç›˜ä¸‹è½½`Prompt_v2.1.md`å’Œ`Prompt_è¡¥ä¸v2.2.md`
   - å®ç°PromptåŠ è½½å’ŒMemoryæ³¨å…¥é€»è¾‘

3. **`app/utils/api_client.py`** - è±†åŒ…APIè°ƒç”¨
   - æ ¹æ®è±†åŒ…APIå®˜æ–¹æ–‡æ¡£å®ç°HTTPè¯·æ±‚
   - å¤„ç†æµå¼å“åº”å’Œé”™è¯¯é‡è¯•

4. **`app/core/extractor.py`** - ä¿¡æ¯æå–
   - å®ç°ä»AIå“åº”ä¸­æå–ç»“æ„åŒ–ä¿¡æ¯çš„é€»è¾‘
   - å¯ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æˆ–JSONè§£æ

5. **å„ä¸ª`app/models/*.py`** - å®Œå–„ORMå…³ç³»
   - æ·»åŠ è¡¨å…³ç³»(relationship)
   - å®Œå–„å­—æ®µå®šä¹‰

---

## ğŸ“š å¼€å‘å»ºè®®

### Week 2 ä»»åŠ¡ä¼˜å…ˆçº§

1. **Day 1-2**: 
   - âœ… ç¯å¢ƒæ­å»ºå’Œæ•°æ®åº“åˆå§‹åŒ–
   - âœ… FastAPIåŸºç¡€æ¡†æ¶è¿è¡Œ
   - â³ è±†åŒ…APIè°ƒç”¨æµ‹è¯•

2. **Day 3-4**:
   - â³ å®ç°`ai_engine.py`æ ¸å¿ƒå¯¹è¯é€»è¾‘
   - â³ å®ç°`memory_manager.py`çš„MemoryåŠ è½½/æ›´æ–°
   - â³ å®ç°`prompt_manager.py`çš„Promptç»„è£…

3. **Day 5-7**:
   - â³ å®ç°`extractor.py`çš„ä¿¡æ¯æå–
   - â³ å®ç°`mode_manager.py`çš„æ¨¡å¼åˆ‡æ¢
   - â³ ç«¯åˆ°ç«¯æµ‹è¯•(å‘é€æ¶ˆæ¯â†’AIå›å¤â†’ä¿¡æ¯æå–â†’æ•°æ®åº“å†™å…¥)

### æµ‹è¯•é©±åŠ¨å¼€å‘
æ¯å®Œæˆä¸€ä¸ªæ¨¡å—,ç«‹å³ç¼–å†™æµ‹è¯•ç”¨ä¾‹:
```bash
# è¿è¡Œæµ‹è¯•
pytest tests/ -v
```

---

## ğŸ› ï¸ è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹æ—¥å¿—
```bash
tail -f logs/app.log
```

### æŸ¥çœ‹æ•°æ®åº“
```bash
sqlite3 data/learning_ai.db
sqlite> SELECT * FROM conversations LIMIT 5;
```

### æµ‹è¯•API
```bash
# å‘é€æµ‹è¯•è¯·æ±‚
curl -X POST "http://localhost:8000/api/chat/send" \
  -H "Content-Type: application/json" \
  -d '{"child_id": 1, "message": "ä»Šå¤©å­¦äº†ä»€ä¹ˆ?"}'
```

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

é¡¹ç›®ç›¸å…³æ–‡æ¡£è¯·æŸ¥çœ‹äº‘ç›˜`/å„¿ç«¥å­¦ä¹ è®°å½•AIé¡¹ç›®æ–‡æ¡£/`:

1. **äº§å“éœ€æ±‚æ–‡æ¡£(PRD)** - åŠŸèƒ½éœ€æ±‚å’Œç”¨æˆ·æ•…äº‹
2. **æŠ€æœ¯æ–¹æ¡ˆ** - æŠ€æœ¯æ¶æ„å’Œé€‰å‹
3. **Promptè®¾è®¡** - Prompt_v2.1.mdå’Œè¡¥ä¸v2.2
4. **MVPæ‰§è¡Œè®¡åˆ’** - 3å‘¨å¼€å‘è®¡åˆ’

---

## âœ… å½“å‰çŠ¶æ€

- [x] é¡¹ç›®ç›®å½•ç»“æ„å·²åˆ›å»º
- [x] æ‰€æœ‰Pythonæ–‡ä»¶å·²ç”Ÿæˆ(å¸¦æ¡†æ¶ä»£ç )
- [x] æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬å·²å‡†å¤‡
- [x] é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ(.env, requirements.txtç­‰)
- [ ] è±†åŒ…APIå¯¹æ¥(**å¾…å®ç°**)
- [ ] Memoryç³»ç»Ÿé€»è¾‘(**å¾…å®ç°**)
- [ ] ä¿¡æ¯æå–å¼•æ“(**å¾…å®ç°**)
- [ ] ä½œæ–‡ç´ ææ¨è(**å¾…å®ç°**)

**ä¸‹ä¸€æ­¥**: å¡«å†™`.env`ä¸­çš„APIå¯†é’¥,å¯åŠ¨æœåŠ¡æµ‹è¯•åŸºç¡€æ¡†æ¶!

---

**é¡¹ç›®åˆ›å»ºæ—¶é—´**: 2024-12-01  
**ä½œè€…**: èŠ‹åœ†è¢«æ—©æ•™  
**æŠ€æœ¯æ”¯æŒ**: AIåŠ©æ‰‹
